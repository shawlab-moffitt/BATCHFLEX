#' Evaluation Cluster Heterogeneity and Evenness
#'
#' Calculate and plot the heterogeneity and evenness scores from `tabula` of `hclust` generated clusters from expression matrices.
#'
#' @param mat A Numeric matrix or list of matrices after pre-processing and/or batch correction with features as rownames and sample names as the column names.
#' @param meta Data frame of sample data with the first column being sample names that match the column names of the matrix.
#' @param batch.1 Column name from the meta file of the column that will be used for batch information.
#' @param cluster_number Used by evaluation pca to select the number of kmeans generated clusters to display in the plot. If NULL is selected, a Silhouette generated cluster number is used.
#' @param topN A positive integer indicating the top number of genes to select based on variance. Default is set to 2000.
#' @param cluster_method The cluster method used by hclust. Default is set to ward.D2. Choices are "ward.D2", "ward.D", "complete", "single", "average", "mccquitty", "median", or "centroid".
#' @param var_type The variance measure used to select the top genes based on variance. Default is set to MAD. Choices are "MAD", "CV", or "VAR".
#' @param fill_percentage A TRUE/FALSE statement that determines if the y axis on the barplot will be a percentage or count. Default is set to TRUE
#' @param plot_title A list of titles for each matrix submitted. Used to named the plots generated by the batch evaluate function. Default will generate titles based on the uncorrected and corrected matrices.
#'
#' @return A list object of cluster HE plots and matrices.
#' @export
#'
#' @examples
#' set.seed(333)
#' test_evaluate <- batch_evaluate(evaluation_method = "cluster_HE", mat = BatchFLEX::preprocess_matrix(BatchFLEX::example_mat), meta = example_meta, batch.1 = "batchflex_study", plot_title = "Unadjusted")
#' test_evaluate$Plots$cluster_HE
#' test_evaluate$Matrices$cluster_HE[-1]
#'
evaluation_cluster_HE <- function(mat,
                                  meta,
                                  batch.1,
                                  cluster_number,
                                  topN,
                                  cluster_method,
                                  var_type,
                                  fill_percentage,
                                  plot_title){
  if (!all(cluster_method %in% c("ward.D2", "ward.D", "complete", "single", "average", "mccquitty", "median", "centroid"))){
    stop("Cluster Method is not found for cluster_HE")
  }
  if (!all(var_type %in% c("MAD", "CV", "VAR"))){
    stop("Variance measure not found for cluster_HE")
  }
  if (is.null(cluster_number)){
    zdataset <- t(apply(mat, 1, scale))
    silhouette <- factoextra::fviz_nbclust(x = t(zdataset), FUNcluster = kmeans, method = "silhouette", verbose = T)
    cluster_number = silhouette$data$clusters[which(max(silhouette$data$y) == silhouette$data$y)]
  }

  evaluation_cluster_HE_list <- list()
  mad <- NULL
  var <- NULL
  cv <- NULL
  featColName <- colnames(mat)[1]
  if (var_type == "MAD"){
    mad <- suppressWarnings(apply(mat, 1, stats::mad))
    mad <- sort(mad, decreasing = T)
    mad <- head(mad, n = topN)
    out <- cbind(names(mad), mad[names(mad)], mat[names(mad),])
    colnames(out) <- c("Gene", "MAD", colnames(mat))
    dataset <- mat[names(mad),]
  }
  else if (var_type == "VAR"){
    var <- suppressWarnings(apply(mat, 1, stats::var))
    var <- sort(var, decreasing = T)
    var <- head(var, n = topN)
    out <- cbind(names(var), var[names(var)], mat[names(var),])
    colnames(out) <- c("Gene", "VAR", colnames(mat))
    dataset <- mat[names(var),]
  }
  else if (var_type == "CV"){
    cv <- suppressWarnings(apply(mat, 1, stats::cv))
    cv <- sort(cv, decreasing = T)
    cv <- head(cv, n = topN)
    out <- cbind(names(cv), cv[names(cv)], mat[names(cv),])
    colnames(out) <- c("Gene", "CV", colnames(mat))
    dataset <- mat[names(cv),]
  }

  zdataset <- t(apply(dataset, 1, scale))
  colnames(zdataset) <- colnames(dataset)
  dataset <- as.data.frame(zdataset)

  dataset[,featColName] <- rownames(dataset)
  dataset <- dataset %>% dplyr::relocate(any_of(featColName))
  dataset_hclust <- dataset[,-1]

  evaluation_hclust <- stats::hclust(dist(t(dataset_hclust)), method = cluster_method)
  evaluation_hclust_cut <- base::sort(cutree(evaluation_hclust, k=cluster_number))
  evaluation_hclust_cut_df <- data.frame(names(evaluation_hclust_cut),
                                         evaluation_hclust_cut)
  colnames(evaluation_hclust_cut_df) <- c(colnames(meta)[1],
                                      paste0(cluster_method, plot_title, sep = ""))
  topN_meta <- base::merge(meta,evaluation_hclust_cut_df,all = T, sort = F)
  evaluation_cluster_HE_list$Matrices$topN_meta <- topN_meta

  plot_df <- topN_meta
  cluster_col <- paste0(cluster_method, plot_title, sep = "")
  plot_df[,batch.1] <- as.factor(plot_df[,batch.1])
  barp <- ggplot2::ggplot(plot_df, aes(fill = !!sym(batch.1), x = !!sym(cluster_col)))

  if (fill_percentage) {
    barp <- barp + geom_bar(position = "fill") +
      theme_minimal()
  } else {
    barp <- barp + geom_bar() +
      theme_minimal()
  }
  barp <- barp + theme(axis.text.x = element_text(size = 18),
                       axis.title.x = element_text(size = 18),
                       axis.text.y = element_text(size = 18),
                       axis.title.y = element_text(size = 18),
                       legend.title = element_text(size = 18),
                       legend.text = element_text(size = 18))


  cluster_batch_freq <- as.data.frame.matrix(table(topN_meta[,cluster_col], topN_meta[,batch.1]))

  Hshannon = tabula::heterogeneity(cluster_batch_freq, method = "shannon") # other options include c("berger", "boone", "brillouin", "mcintosh", "shannon", "simpson")
  Hberger = tabula::heterogeneity(cluster_batch_freq, method = "berger") # other options include c("berger", "boone", "brillouin", "mcintosh", "shannon", "simpson")
  Hboone = tabula::heterogeneity(cluster_batch_freq, method = "boone") # other options include c("berger", "boone", "brillouin", "mcintosh", "shannon", "simpson")
  Hbrillouin = tabula::heterogeneity(cluster_batch_freq, method = "brillouin") # other options include c("berger", "boone", "brillouin", "mcintosh", "shannon", "simpson")
  Hmcintosh = tabula::heterogeneity(cluster_batch_freq, method = "mcintosh") # other options include c("berger", "boone", "brillouin", "mcintosh", "shannon", "simpson")

  heterogeneity_matrix = as.data.frame(cbind(Hshannon, Hberger,
                                                    Hboone, Hbrillouin,
                                                    Hmcintosh))
  heterogeneity_matrix$Cluster <- paste0(cluster_method,"_Cluster_",1:nrow(heterogeneity_matrix))
  heterogeneity_matrix <- heterogeneity_matrix %>%
    dplyr::relocate(Cluster)
  evaluation_cluster_HE_list$Matrices$heterogeneity <- heterogeneity_matrix

  #vp_het <- viewport(width = 0.3, height = heterogeneity_height)
  #heterogeneity_matrix_table <- gridExtra::tableGrob(heterogeneity_matrix, vp = vp_het)

  avg_heterogeneity_vec <- apply(heterogeneity_matrix[,-1],2,function(x) base::mean(x,na.rm = T))
  avg_heterogeneity_df <- data.frame(Heterogeneity_Method = names(avg_heterogeneity_vec),
                                     Average_Heterogeneity = unname(avg_heterogeneity_vec))
  evaluation_cluster_HE_list$Matrices$average_heterogeneity <- avg_heterogeneity_df

  Eshannon = tabula::evenness(cluster_batch_freq, method="shannon")
  Ebrillouin = tabula::evenness(cluster_batch_freq, method="brillouin")
  Emcintosh = tabula::evenness(cluster_batch_freq, method="mcintosh")
  Esimpson = tabula::evenness(cluster_batch_freq, method="simpson")

  evenness_matrix = as.data.frame(cbind(Eshannon, Ebrillouin,
                                               Emcintosh, Esimpson))
  evenness_matrix$Cluster <- paste0(cluster_method,"_Cluster_",1:nrow(evenness_matrix))
  evenness_matrix <- evenness_matrix %>%
    dplyr::relocate(Cluster)
  evaluation_cluster_HE_list$Matrices$evenness <- evenness_matrix

  #vp_even <- viewport(width = 0.3, height = evenness_height)
  complete_table <- cbind(heterogeneity_matrix, evenness_matrix[,-1])
  complete_table <- round(as.matrix(complete_table[,-1]), 6)
  complete_table <- as.data.frame(complete_table)
  complete_table$Cluster <- as.vector(1:nrow(complete_table))
  complete_table <- dplyr::relocate(complete_table, "Cluster")
  complete_matrix_table <- gridExtra::tableGrob(complete_table, theme = gridExtra::ttheme_default(base_size = 11, base_colour = "black", base_family = "",
                                                                                                  parse = FALSE, padding = unit(c(2, 2), "mm")))

  avg_evenness_vec <- apply(evenness_matrix[,-1],2,function(x) mean(x,na.rm = T))
  avg_evenness_df <- data.frame(Evenness_Method = names(avg_evenness_vec),
                                Average_Evenness = unname(avg_evenness_vec))
  evaluation_cluster_HE_list$Matrices$average_evenness <- avg_evenness_df

  barpntable_list <- list(barp, complete_matrix_table)
  heterogeneity_height <- 0.1 * nrow(heterogeneity_matrix) + 0.1
  evenness_height <- 0.1 * nrow(evenness_matrix) + 0.1
  complete_height <- heterogeneity_height + evenness_height

  barp_height <-  heterogeneity_height + evenness_height
  barpntable <- ggpubr::ggarrange(plotlist = barpntable_list,
                                  nrow = 2, ncol = 1,
                                  heights = c(barp_height, complete_height))

  evaluation_cluster_HE_list$Plots$bar_plot <- barpntable
  return(evaluation_cluster_HE_list)
}
