#' Evaluation Surrogate Variable Analysis
#'
#' Generates a density plot (`ggplot2`) of associated probabilities calculated from `sva` using a meta and expression matrix.
#' Also generates a matrix of surrogate variables calculated from `sva`.
#'
#' @param mat A Numeric matrix or list of matrices after pre-processing and/or batch correction with features as rownames and sample names as the column names
#' @param meta Data frame of sample data with the first column being sample names that match the column names of the matrix
#' @param variable_of_interest Column name from the meta file of the column that will be used for the variable of interest information
#' @param sva_nsv_method Used by SVA to generate surrogate variables. Choices are "be" and "leek". Default is set to "be"
#' @param plot_title A list of titles for each matrix submitted. Used to named the plots generated by the batch evaluate function. Default will generate titles based on the uncorrected and corrected matrices.
#'
#' @return A list object of probability association plots and surrogate variable matrices
#' @export
#'
#' @examples
#' set.seed(333)
#' test_evaluate <- batch_evaluate(evaluation_method = "sva", mat = BatchFLEX::preprocess_matrix(BatchFLEX::example_mat), meta = example_meta, batch.1 = "batchflex_study", variable_of_interest = "Major_Lineage", sva_nsv_method = "be")
#' test_evaluate$Plots$sva
#'
evaluation_sva <- function(mat,
                           meta,
                           variable_of_interest,
                           sva_nsv_method,
                           plot_title){
  evaluation_sva_list <- list()
  mod <- stats::model.matrix(reformulate(variable_of_interest), data = meta)
  mod_null <- stats::model.matrix(~1, data = meta)
  SVA_nsv <- sva::num.sv(mat, mod, method = sva_nsv_method)
  SVA_object <- sva::sva(mat,
                         mod, mod_null,
                         n.sv = SVA_nsv,
                         numSVmethod = sva_nsv_method
  )
  SVA_probability_df <- data.frame(Genes = 1:length(SVA_object$pprob.gam),
                                               latent_variable = SVA_object$pprob.gam,
                                               variable_of_intrest = SVA_object$pprob.b
  )
  SVA_probability_df_longer <- tidyr::pivot_longer(SVA_probability_df, !Genes, names_to = "variable_type")
  SVA_probability_df_longer <- dplyr::rename(SVA_probability_df_longer, "probability_association_of_each_gene" = "value")
  evaluation_sva_list$Plots$svaprob <- ggplot(SVA_probability_df_longer,
                                                  mapping = aes(x = probability_association_of_each_gene, fill = variable_type, alpha = 0.5)) +
    geom_density() +
    ggtitle(plot_title) +
    theme(axis.text.x = element_text(size = 18),
          axis.title.x = element_text(size = 18),
          axis.text.y = element_text(size = 18),
          axis.title.y = element_text(size = 18),
          legend.title = element_text(size = 18),
          legend.text = element_text(size = 18),
          plot.title = element_text(size = 18))
  evaluation_sva_list$Matrices$sv <- SVA_object$sv

  return(evaluation_sva_list)
}


