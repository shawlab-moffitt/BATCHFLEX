#' Evaluation Cluster Analysis
#'
#' Generates cluster analysis plots using wss, silhouette, and Dunn indexes calculated from expression matrices.
#'
#' @param mat A Numeric matrix or list of matrices after pre-processing and/or batch correction with features as rownames and sample names as the column names
#' @param cluster_analysis_method Used to select cluster analysis method. Elbow = "wss", Silhouette = "silhouette", Dunn = "dunn', all generates plots from each method
#' @param plot_title A list of titles for each matrix submitted. Used to named the plots generated by the batch evaluate function. Default will generate titles based on the uncorrected and corrected matrices.
#'
#' @return A list object of cluster plots for each selected cluster analysis method
#' @export
#'
#' @examples
#' set.seed(333)
#' test_evaluate <- batch_evaluate(evaluation_method = "cluster_analysis", mat = BatchFLEX::preprocess_matrix(BatchFLEX::example_mat), meta = example_meta, batch.1 = "batchflex_study", variable_of_interest = "Major_Lineage", cluster_analysis_method = "silhouette")
#' test_evaluate$Plots$cluster_analysis
#'
evaluation_cluster_analysis = function(mat,
                                       cluster_analysis_method,
                                       plot_title){

  mat <- t(apply(mat, 1, scale))

  if("all" %in% cluster_analysis_method){
    cluster_analysis_method = c("wss", "silhouette", "dunn")
  }
  if(!all(cluster_analysis_method %in% c("wss", "silhouette", "dunn"))){
    stop("Cluster analysis method not found")
  }
  cluster_plot_list <- list()
  if ("wss" %in% cluster_analysis_method){
    cluster_plot_list$wss <- factoextra::fviz_nbclust(x = t(mat), FUNcluster = kmeans, method = "wss", verbose = T)+
      labs(title = paste0("Elbow Cluster Analysis\n", plot_title, sep = " ")) +
      theme(axis.text.x = element_text(size = 18),
            axis.title.x = element_text(size = 18),
            axis.text.y = element_text(size = 18),
            axis.title.y = element_text(size = 18),
            legend.title = element_text(size = 18),
            legend.text = element_text(size = 18),
            plot.title = element_text(size = 18))
  }
  if ("silhouette" %in% cluster_analysis_method){
    cluster_plot_list$silhouette <- factoextra::fviz_nbclust(x = t(mat), FUNcluster = kmeans, method = "silhouette", verbose = T)+
      labs(title = paste0("Silhouette Cluster Analysis\n", plot_title, sep = " ")) +
      theme(axis.text.x = element_text(size = 18),
            axis.title.x = element_text(size = 18),
            axis.text.y = element_text(size = 18),
            axis.title.y = element_text(size = 18),
            legend.title = element_text(size = 18),
            legend.text = element_text(size = 18),
            plot.title = element_text(size = 18))
  }
  if ("dunn" %in% cluster_analysis_method){
    set.seed(333)
    dunn_k <- c(2:10)
    dunnin <- c()
    for (i in dunn_k){
      dunnin[i] <- clValid::dunn(
        distance = dist(t(mat)),
        clusters = kmeans(t(mat), i)$cluster
      )
    }
    dunn_index_analysis <- as.data.frame(cbind(dunn_k, dunnin[-1]))
    colnames(dunn_index_analysis) <- c("cluster_number", "dunn_index")
    cluster_plot_list$dunn <- ggplot(data = dunn_index_analysis, mapping = aes(x = cluster_number, y = dunn_index))+
      geom_point(color = "dodgerblue1")+
      geom_line(color = "dodgerblue1")+
      geom_vline(
        xintercept = dunn_index_analysis$cluster_number[which(max(dunn_index_analysis$dunn_index) == dunn_index_analysis$dunn_index)],
        color = "dodgerblue1",
        linetype = 2
      ) +
      theme_classic()+
      ggtitle(paste0("Dunn Cluster Analysis\n", plot_title, sep = " ")) +
      theme(axis.text.x = element_text(size = 18),
            axis.title.x = element_text(size = 18),
            axis.text.y = element_text(size = 18),
            axis.title.y = element_text(size = 18),
            legend.title = element_text(size = 18),
            legend.text = element_text(size = 18),
            plot.title = element_text(size = 18))
  }
  return(cluster_plot_list)
}
