#' Evaluation Heatmap
#'
#' @param mat A Numeric matrix or list of matrices after pre-processing and/or batch correction with features as rownames and sample names as the column names.
#' @param meta Data frame of sample data with the first column being sample names that match the column names of the matrix.
#' @param batch.1 Column name from the meta file of the column that will be used for batch information.
#' @param variable_of_interest Column name from the meta file of the column that will be used for the variable of interest information.
#' @param topN A positive integer indicating the top number of genes to select based on variance. Default is set to 2000.
#' @param cluster_method he cluster method used by hclust. Default is set to ward.D2. Choices are "ward.D2", "ward.D", "complete", "single", "average", "mccquitty", "median", or "centroid".
#' @param var_type The variance measure used to select the top genes based on variance. Default is set to MAD. Choices are "MAD", "CV", or "VAR".
#' @param heatmap_annotation A vector of column names from the meta file to include in the heatmap annotation
#' @param heatmap_rownames A TRUE/FALSE statement to determine whether or not rownames will be included in the heatmap
#' @param heatmap_colnames A TRUE/FALSE statement to determine whether or not colnames will be included in the heatmap
#' @param plot_title A list of titles for each matrix submitted. Used to named the plots generated by the batch evaluate function. Default will generate titles based on the uncorrected and corrected matrices.
#'
#' @return A list object of heatmap plots.
#' @export
#'
#' @examples
#' set.seed(333)
evaluation_heatmap <- function(mat,
                               meta,
                               batch.1,
                               variable_of_interest,
                               topN,
                               cluster_method,
                               var_type,
                               heatmap_annotation,
                               heatmap_rownames,
                               heatmap_colnames,
                               plot_title){
  if (!all(cluster_method %in% c("ward.D2", "ward.D", "complete", "single", "average", "mccquitty", "median", "centroid"))){
    stop("Cluster Method is not found for heatmap")
  }
  if (!all(var_type %in% c("MAD", "CV", "VAR"))){
    stop("Variance measure not found for heatmap")
  }
  if (!all(heatmap_annotation %in% colnames(meta))){
    stop("Heatmap Annotation is Not Included in Meta Column Names")
  }
  if (is.null(heatmap_annotation)){
    heatmap_annotation <- c(batch.1, variable_of_interest)
  }
  cv <- function(x){
    (sd(x)/mean(x))*100
  }
  evaluation_heatmap_list <- list()
  rownames(meta) <- meta[,1]
  meta_sub <- meta[,heatmap_annotation, drop = F]
  heat_colAnn <- ComplexHeatmap::HeatmapAnnotation(df = meta_sub,
                                                   name = heatmap_annotation,
                                                   which = 'col',
                                                   annotation_name_gp = grid::gpar(fontsize = 18),
                                                   annotation_legend_param = list(title_gp = grid::gpar(fontsize = 18), labels_gp = grid::gpar(fontsize = 18)))
  if(is.null(heatmap_annotation)){
    heat_colAnn <- NULL
  }
  featColName_heatmap <- "Features"
  evaluation_mad_heatmap <- NULL
  evaluation_var_heatmap <- NULL
  evaluation_cv_heatmap <- NULL
  if (var_type == "MAD"){
    evaluation_mad_heatmap <- suppressWarnings(apply(mat, 1, stats::mad))
    evaluation_mad_heatmap <- sort(evaluation_mad_heatmap, decreasing = T)
    evaluation_mad_heatmap <- head(evaluation_mad_heatmap, n = topN)
    out <- cbind(names(evaluation_mad_heatmap), evaluation_mad_heatmap[names(evaluation_mad_heatmap)], mat[names(evaluation_mad_heatmap),])
    colnames(out) <- c("Gene", "MAD", colnames(mat))
    dataset_heatmap <- mat[names(evaluation_mad_heatmap),]
  }else if (var_type == "VAR"){
    evaluation_var_heatmap <- suppressWarnings(apply(mat, 1, stats::var))
    evaluation_var_heatmap <- sort(evaluation_var_heatmap, decreasing = T)
    evaluation_var_heatmap <- head(evaluation_var_heatmap, n = topN)
    out <- cbind(names(evaluation_var_heatmap), evaluation_var_heatmap[names(evaluation_var_heatmap)], mat[names(evaluation_var_heatmap),])
    colnames(out) <- c("Gene", "VAR", colnames(mat))
    dataset_heatmap <- mat[names(evaluation_var_heatmap),]
  }else if (var_type == "CV"){
    evaluation_cv_heatmap <- suppressWarnings(apply(mat, 1, cv))
    evaluation_cv_heatmap <- sort(evaluation_cv_heatmap, decreasing = T)
    evaluation_cv_heatmap <- head(evaluation_cv_heatmap, n = topN)
    out <- cbind(names(evaluation_cv_heatmap), evaluation_cv_heatmap[names(evaluation_cv_heatmap)], mat[names(evaluation_cv_heatmap),])
    colnames(out) <- c("Gene", "CV", colnames(mat))
    dataset_heatmap <- mat[names(evaluation_cv_heatmap),]
  }

  zdataset_heatmap <- t(apply(dataset_heatmap, 1, scale))
  colnames(zdataset_heatmap) <- colnames(dataset_heatmap)
  dataset_heatmap <- as.data.frame(zdataset_heatmap)
  dataset_heatmap[,featColName_heatmap] <- rownames(dataset_heatmap)
  dataset_heatmap <- dataset_heatmap %>% dplyr::relocate(any_of(featColName_heatmap))
  matrix_heatmap <- as.matrix(dataset_heatmap[,-1])
  evaluation_heatmap_list$heatmap <- ggpubr::ggarrange(grid::grid.grabExpr(ComplexHeatmap::draw(suppressMessages(ComplexHeatmap::Heatmap(matrix = matrix_heatmap,
                                                                               column_title = plot_title,
                                                                               top_annotation = heat_colAnn,
                                                                               show_row_names = heatmap_rownames,
                                                                               show_column_names = heatmap_colnames,
                                                                               heatmap_legend_param = list(title = "Expression", title_gp = grid::gpar(fontsize = 18), labels_gp = grid::gpar(fontsize = 18)),
                                                                               show_heatmap_legend = TRUE,
                                                                               clustering_method_columns = cluster_method,
                                                                               column_title_gp = grid::gpar(fontsize = 18))))))
  return(evaluation_heatmap_list)
}



