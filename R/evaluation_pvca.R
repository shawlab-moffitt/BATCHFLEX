#' Evaluation PVCA
#'
#' @param mat A Numeric matrix or list of matrices after pre-processing and/or batch correction with features as rownames and sample names as the column names.
#' @param meta Data frame of sample data with the first column being sample names that match the column names of the matrix.
#' @param batch.1 Column name from the meta file of the column that will be used for batch information.
#' @param variable_of_interest Column name from the meta file of the column that will be used for the variable of interest information.
#' @param topN_pvca A positive integer indicating the top number of genes to select based on variance for PVCA. Default is set to 20000.
#' @param var_type The variance measure used to select the top genes based on variance. Default is set to MAD. Choices are "MAD", "CV", or "VAR".
#' @param variable_choices Used by the PVCA function to select which variables to plot. Default is a combination of the batch and variable of interest.
#' @param pvca_pct A numeric between 0 and 1 that indicates the percentile value of the minimum amount of the variabilities that the selected principal components need to explain.
#' @param plot_title A list of titles for each matrix submitted. Used to named the plots generated by the batch evaluate function. Default will generate titles based on the uncorrected and corrected matrices.
#'
#' @return A list object of PVCA plots.
#' @export
#'
#' @examples
#' set.seed(333)
evaluation_pvca <- function(mat,
                            meta,
                            batch.1,
                            variable_of_interest,
                            topN_pvca,
                            var_type,
                            variable_choices,
                            pvca_pct,
                            plot_title){
  if (!all(var_type %in% c("MAD", "CV", "VAR"))){
    stop("Variance measure not found for PVCA")
  }
  cv <- function(x){
    (sd(x)/mean(x))*100
  }
  if (is.null(variable_choices)){
    variable_choices = c(batch.1, variable_of_interest)
  }
  if (!(length(variable_choices) <= 2)) {
    message("PVCA requires at least two variable choices")
  }
  if (pvca_pct < 0 | pvca_pct > 1){
    stop("pvca percent should be between 0 and 1")
  }
  evaluation_pvca_list <- list()
  featColName_pvca <- "Features"
  evaluation_mad_pvca <- NULL
  evaluation_var_pvca <- NULL
  evaluation_cv_pvca <- NULL
  if (var_type == "MAD"){
    evaluation_mad_pvca <- suppressWarnings(apply(mat, 1, stats::mad))
    evaluation_mad_pvca <- sort(evaluation_mad_pvca, decreasing = T)
    evaluation_mad_pvca <- head(evaluation_mad_pvca, n = topN_pvca)
    out <- cbind(names(evaluation_mad_pvca), evaluation_mad_pvca[names(evaluation_mad_pvca)], mat[names(evaluation_mad_pvca),])
    colnames(out) <- c("Gene", "MAD", colnames(mat))
    dataset_pvca <- mat[names(evaluation_mad_pvca),]
  }else if (var_type == "VAR"){
    evaluation_var_pvca <- suppressWarnings(apply(mat, 1, stats::var))
    evaluation_var_pvca <- sort(evaluation_var_pvca, decreasing = T)
    evaluation_var_pvca <- head(evaluation_var_pvca, n = topN_pvca)
    out <- cbind(names(evaluation_var_pvca), evaluation_var_pvca[names(evaluation_var_pvca)], mat[names(evaluation_var_pvca),])
    colnames(out) <- c("Gene", "VAR", colnames(mat))
    dataset_pvca <- mat[names(evaluation_var_pvca),]
  }else if (var_type == "CV"){
    evaluation_cv_pvca <- suppressWarnings(apply(mat, 1, cv))
    evaluation_cv_pvca <- sort(evaluation_cv_pvca, decreasing = T)
    evaluation_cv_pvca <- head(evaluation_cv_pvca, n = topN_pvca)
    out <- cbind(names(evaluation_cv_pvca), evaluation_cv_pvca[names(evaluation_cv_pvca)], mat[names(evaluation_cv_pvca),])
    colnames(out) <- c("Gene", "CV", colnames(mat))
    dataset_pvca <- mat[names(evaluation_cv_pvca),]
  }
  zdataset_pvca <- t(apply(dataset_pvca, 1, scale))
  colnames(zdataset_pvca) <- colnames(dataset_pvca)
  dataset_pvca <- as.data.frame(zdataset_pvca)
  dataset_pvca[,featColName_pvca] <- rownames(dataset_pvca)
  dataset_pvca <- dataset_pvca %>% dplyr::relocate(any_of(featColName_pvca))
  matrix_pvca <- as.matrix(dataset_pvca[,-1])

  final_pvca <- statVisual::PVCA(
    clin_data = meta,
    clin_subjid = colnames(meta)[1],
    gene_data = matrix_pvca,
    batch.factors = variable_choices,
    pct_threshold = pvca_pct) +
    ggtitle(plot_title) +
    theme(axis.text.x = element_text(size = 12),
          axis.title.x = element_text(size = 18),
          axis.text.y = element_text(size = 18),
          axis.title.y = element_text(size = 18),
          legend.title = element_text(size = 18),
          legend.text = element_text(size = 18),
          plot.title = element_text(size = 18))
  final_pvca$layers[[2]]$aes_params$size <- 5

  evaluation_pvca_list$pvca <- final_pvca

  return(evaluation_pvca_list)
}



